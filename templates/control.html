<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Class Timer Control</title>
  <style>
    :root { color-scheme: dark light; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 2rem; background: #0b0b0c; color: #e6e6e6; }
    h1 { margin-top: 0; }
    .bar { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
    label { font-weight: 600; }
    select, textarea, button, input { font: inherit; }
    textarea { width: 100%; min-height: 320px; resize: vertical; padding: 1rem; border-radius: .5rem; border: 1px solid #333; background: #111; color: #e6e6e6; }
    input[type="time"], input[type="text"] { padding: .4rem .5rem; border-radius: .4rem; border: 1px solid #333; background: #111; color: #e6e6e6; }
    .row { margin: 1rem 0; }
    .actions { display: flex; gap: .75rem; align-items: center; }
    .btn { padding: .6rem 1rem; border-radius: .5rem; border: 1px solid #444; background: #1f1f22; color: #fff; cursor: pointer; }
    .btn.primary { background: #3b82f6; border-color: #3b82f6; }
    .btn.ghost { background: transparent; border-color: #333; }
    .msg { padding: .75rem 1rem; border-radius: .5rem; margin: 1rem 0; }
    .msg.ok { background: #063; color: #cfe; }
    .msg.err { background: #5a1a1a; color: #fee; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    @media (min-width: 1100px) { .grid { grid-template-columns: 1fr 420px; } }
    .card { border: 1px solid #2a2a2a; background: #121214; border-radius: .75rem; padding: 1rem; }
    .card h3 { margin: 0 0 .5rem 0; }
    code { background: #1a1a1d; padding: 0 .25rem; border-radius: .25rem; }
    a { color: #8ab4ff; }

    .theme-grid { display: grid; grid-template-columns: repeat(5, minmax(120px, 1fr)); gap: .5rem; }
    .theme-item { display: flex; align-items: center; gap: .5rem; padding: .5rem; border: 1px solid #2a2a2a; border-radius: .5rem; background: #0f0f12; }

    .week { display: grid; grid-template-columns: 1fr; gap: .75rem; }
    .day { border: 1px solid #1f1f22; background: #0f0f12; border-radius: .5rem; padding: .75rem; }
    .day h4 { margin: 0 0 .5rem 0; font-size: 1rem; color: #cfd3d7; }
    .rows { display: grid; gap: .5rem; }
    .row-grid { display: grid; grid-template-columns: 1.2fr .8fr .8fr auto; gap: .5rem; align-items: center; }
    .tiny { font-size: .85rem; color: #a8adb2; }
  </style>
</head>
<body>
  <h1>Class Timer Control</h1>
  <div class="bar row">
    <a class="btn" href="/display" target="_blank">Open Display</a>
    <a class="btn" href="/now" target="_blank">View /now</a>
  </div>

  {% if message %}<div class="msg ok">{{ message }}</div>{% endif %}
  {% if error %}<div class="msg err">{{ error }}</div>{% endif %}

  <form id="controlForm" method="post">
    <div class="grid">
      <div class="card">
        <h3>Theme</h3>
        <div class="theme-grid" id="themeGrid">
          <label class="theme-item"><input type="checkbox" class="theme-check" value="fire"> Fire / Embers</label>
          <label class="theme-item"><input type="checkbox" class="theme-check" value="liquid"> Liquid</label>
          <label class="theme-item"><input type="checkbox" class="theme-check" value="frost"> Frost</label>
          <label class="theme-item"><input type="checkbox" class="theme-check" value="poison"> Poison Gas</label>
          <label class="theme-item"><input type="checkbox" class="theme-check" value="random"> Random</label>
        </div>
        <input type="hidden" id="theme" name="theme" value="{{ theme }}" />
      </div>

      <div class="card" id="statusCard">
        <h3>Live Status</h3>
        <div class="rows">
          <div class="row-grid" style="grid-template-columns: 1fr 1fr;">
            <div><span class="tiny">State</span><div id="st-state">—</div></div>
            <div><span class="tiny">Remaining</span><div id="st-remaining">—</div></div>
          </div>
          <div class="row-grid" style="grid-template-columns: 1fr 1fr;">
            <div><span class="tiny">Current</span><div id="st-label">—</div></div>
            <div><span class="tiny">Ends</span><div id="st-ends">—</div></div>
          </div>
          <div><span class="tiny">Next</span><div id="st-next">—</div></div>
          <div class="actions">
            <button type="button" class="btn" id="refreshNow">Refresh</button>
            <span class="tiny" id="sseIndicator">SSE: connecting…</span>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Weekly Schedule</h3>
        <p class="tiny">Add one or more classes per day. Times use 24-hour format.</p>
        <div class="week" id="week"></div>
        <!-- Hidden raw JSON for backend compatibility -->
        <textarea id="schedule_json" name="schedule_json" style="display:none">{{ schedule_json }}</textarea>
        <div class="actions">
          <button class="btn ghost" type="button" id="loadSample">Load Sample</button>
          <button class="btn primary" type="submit">Save</button>
        </div>
      </div>

      <div class="card">
        <h3>Notes</h3>
        <ul>
          <li>Timer auto-starts when current time is within a class window.</li>
          <li>Days are Monday–Sunday. You can add multiple classes per day.</li>
          <li>"Random" theme will pick a different look on the display.</li>
        </ul>
      </div>
    </div>
  </form>

  <script>
    const DAYS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

    function createDaySection(day){
      const wrap = document.createElement('div');
      wrap.className = 'day';
      const title = document.createElement('h4');
      title.textContent = day;
      const rows = document.createElement('div'); rows.className = 'rows';
      const addBtn = document.createElement('button');
      addBtn.type = 'button'; addBtn.className = 'btn'; addBtn.textContent = 'Add Class';
      addBtn.addEventListener('click', ()=> rows.appendChild(createRow({ label:'', start:'09:00', end:'09:50' })) );
      wrap.appendChild(title); wrap.appendChild(rows); wrap.appendChild(addBtn);
      return {wrap, rows};
    }

    function createRow(data){
      const row = document.createElement('div');
      row.className = 'row-grid';
      row.innerHTML = `
        <input type="text" placeholder="Label" value="${data.label||''}" />
        <input type="time" value="${data.start||'09:00'}" />
        <input type="time" value="${data.end||'09:50'}" />
        <button type="button" class="btn">Remove</button>
      `;
      row.querySelector('button').addEventListener('click', ()=> row.remove());
      return row;
    }

    function parseInitial(){
      try { return JSON.parse(document.getElementById('schedule_json').value || '[]'); }
      catch(e){ return []; }
    }

    function expandToDayRows(entries){
      // Convert schedule entries to per-day rows map
      const map = Object.fromEntries(DAYS.map(d=>[d,[]]));
      for (const ev of entries){
        let days = ev.days;
        if (!days) days = DAYS;
        if (typeof days === 'string'){
          const s = days.toLowerCase();
          if (s === 'all') days = DAYS; else days = [ev.days];
        }
        for (const d of days){
          const day = (typeof d === 'number') ? DAYS[d] : String(d).slice(0,3).charAt(0).toUpperCase() + String(d).slice(1,3).toLowerCase();
          if (!DAYS.includes(day)) continue;
          map[day].push({ label: ev.label || 'Class', start: ev.start, end: ev.end });
        }
      }
      // Sort rows per day by start time
      for (const d of DAYS){ map[d].sort((a,b)=> (a.start||'').localeCompare(b.start||'')); }
      return map;
    }

    function collectSchedule(){
      // Build one entry per row with specific day string
      const weekEl = document.getElementById('week');
      const out = [];
      const daySections = weekEl.querySelectorAll('.day');
      daySections.forEach(sec =>{
        const day = sec.querySelector('h4').textContent;
        sec.querySelectorAll('.row-grid').forEach(row=>{
          const [labelEl, startEl, endEl] = row.querySelectorAll('input');
          const label = labelEl.value.trim() || 'Class';
          const start = (startEl.value || '').slice(0,5);
          const end = (endEl.value || '').slice(0,5);
          if (!/^\d{2}:\d{2}$/.test(start) || !/^\d{2}:\d{2}$/.test(end)) return;
          out.push({ label, days: day, start, end });
        });
      });
      return out;
    }

    function setThemeCheckbox(value){
      const checks = Array.from(document.querySelectorAll('.theme-check'));
      checks.forEach(c => c.checked = (c.value === value));
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      // Build week UI
      const week = document.getElementById('week');
      const sections = {};
      DAYS.forEach(d=>{ const sec = createDaySection(d); sections[d]=sec; week.appendChild(sec.wrap); });
      const initial = parseInitial();
      const map = expandToDayRows(initial);
      for (const d of DAYS){
        if (!map[d] || map[d].length === 0){
          // add one empty row for convenience
          sections[d].rows.appendChild(createRow({ label:'', start:'', end:'' }));
        } else {
          map[d].forEach(ev=> sections[d].rows.appendChild(createRow(ev)));
        }
      }

      // Theme setup
      const initialTheme = document.getElementById('theme').value || 'fire';
      setThemeCheckbox(initialTheme);
      document.querySelectorAll('.theme-check').forEach(chk =>{
        chk.addEventListener('change', (e)=>{
          if (e.target.checked){
            document.querySelectorAll('.theme-check').forEach(c=>{ if (c!==e.target) c.checked = false; });
            document.getElementById('theme').value = e.target.value;
          } else {
            // prevent all-unchecked: keep at least one
            e.target.checked = true;
          }
        });
      });

      document.getElementById('loadSample').addEventListener('click', ()=>{
        // Simple M-F sample: two periods
        const sample = [
          { label:'Period 1', days:['Mon','Tue','Wed','Thu','Fri'], start:'09:00', end:'09:50' },
          { label:'Break', days:['Mon','Tue','Wed','Thu','Fri'], start:'09:50', end:'10:00' },
          { label:'Period 2', days:['Mon','Tue','Wed','Thu','Fri'], start:'10:00', end:'10:50' }
        ];
        const m2 = expandToDayRows(sample);
        for (const d of DAYS){
          const r = sections[d].rows; r.innerHTML = '';
          (m2[d] && m2[d].length? m2[d] : [{label:'',start:'',end:''}]).forEach(ev=> r.appendChild(createRow(ev)));
        }
      });

      // On submit, serialize GUI to hidden JSON
      document.getElementById('controlForm').addEventListener('submit', ()=>{
        const data = collectSchedule();
        document.getElementById('schedule_json').value = JSON.stringify(data, null, 2);
      });

      // --- Live Status Panel ---
      const elState = document.getElementById('st-state');
      const elRem = document.getElementById('st-remaining');
      const elLabel = document.getElementById('st-label');
      const elEnds = document.getElementById('st-ends');
      const elNext = document.getElementById('st-next');
      const elSSE = document.getElementById('sseIndicator');

      function fmt(sec){
        sec = Math.max(0, Math.floor(Number(sec)||0));
        const m = Math.floor(sec/60);
        const s = String(sec%60).padStart(2,'0');
        return `${m}:${s}`;
      }
      function updateStatus(data){
        if (!data) return;
        const status = data.status||'idle';
        elState.textContent = status === 'in_session' ? 'In Session' : 'Idle';
        elRem.textContent = fmt(data.remaining_seconds||0);
        elLabel.textContent = data.current_label || (status==='in_session' ? 'Class' : 'Idle');
        elEnds.textContent = data.ends_at ? data.ends_at : '—';
        const nextParts = [];
        if (data.next_label) nextParts.push(data.next_label);
        if (data.next_start) nextParts.push(`@ ${data.next_start}`);
        elNext.textContent = nextParts.length? nextParts.join(' ') : '—';
      }
      async function refreshNow(){
        try{
          const res = await fetch('/now', { cache: 'no-store' });
          if (res.ok){ updateStatus(await res.json()); }
        }catch(e){ /* ignore */ }
      }

      document.getElementById('refreshNow').addEventListener('click', refreshNow);

      (function startStatus(){
        refreshNow();
        if ('EventSource' in window){
          try {
            const es = new EventSource('/events');
            elSSE.textContent = 'SSE: connected';
            es.onmessage = (e)=>{
              try {
                const msg = JSON.parse(e.data);
                const type = msg.event || 'message';
                const data = msg.data || {};
                if (type === 'snapshot') updateStatus(data);
                else if (type === 'config') { refreshNow(); }
                else updateStatus(data);
              } catch(err){ /* ignore */ }
            };
            es.onerror = ()=>{ elSSE.textContent = 'SSE: disconnected (retrying)'; };
          } catch(err){ elSSE.textContent = 'SSE: unavailable'; setInterval(refreshNow, 15000); }
        } else {
          elSSE.textContent = 'SSE: unavailable (polling)';
          setInterval(refreshNow, 15000);
        }
      })();

    });
  </script>
</body>
</html>
